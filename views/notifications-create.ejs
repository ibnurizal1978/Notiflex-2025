<%- include('layouts/header') %>
<main role="main" class="main-content">
  <div class="container-fluid">
    <div class="row justify-content-center">
      <div class="col-12 col-xl-12">
        <div class="card shadow mb-4">
          <div class="card-body">
            <h2 class="h3 mb-4 page-title">Create Reminder Notification</h2>
            <form id="createNotificationsForm">
              <div id="notificationRows">
                <div class="notification-row row mb-3">
                  <div class="col-md-3">
                    <label>Object Type</label>
                    <select class="form-control" name="object_type_id" required>
                      <option value="">Select...</option>
                      <% (objectTypes || []).forEach(function(obj) { %>
                        <option value="<%= obj.id %>"><%= obj.name %></option>
                      <% }); %>
                    </select>
                  </div>
                  <div class="col-md-2">
                    <label>Remind In (days)</label>
                    <input type="number" class="form-control" name="remind_in" min="1" required>
                  </div>
                  <div class="col-md-2">
                    <label>Remind Using</label>
                    <select class="form-control" name="remind_using" required>
                      <option value="EMAIL">EMAIL</option>
                    </select>
                  </div>
                  <div class="col-md-4">
                    <label>Group</label>
                    <select class="form-control" name="group_id" required>
                      <option value="">Select...</option>
                      <% (groups || []).forEach(function(g) { %>
                        <option value="<%= g.id %>"><%= g.name %></option>
                      <% }); %>
                    </select>
                  </div>
                  <div class="col-md-1 d-flex align-items-end">
                    <button type="button" class="btn btn-danger btn-remove-row" style="display:none">&times;</button>
                  </div>
                </div>
              </div>
              <button type="button" id="addRowBtn" class="btn btn-secondary mb-3">Add Another</button>
              <div class="text-right">
                <button type="submit" class="btn btn-primary">Save</button>
              </div>
              <div id="notifMsg" class="mt-3"></div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>
<script>
function createRow() {
  const row = document.createElement('div');
  row.className = 'notification-row row mb-3';
  row.innerHTML = `
    <div class="col-md-3">
      <label>Object Type</label>
      <select class="form-control" name="object_type_id" required>
        <option value="">Select...</option>
        <% (objectTypes || []).forEach(function(obj) { %>
          <option value="<%= obj.id %>"><%= obj.name %></option>
        <% }); %>
      </select>
    </div>
    <div class="col-md-2">
      <label>Remind In (days)</label>
      <input type="number" class="form-control" name="remind_in" min="1" required>
    </div>
    <div class="col-md-2">
      <label>Remind Using</label>
      <select class="form-control" name="remind_using" required>
        <option value="EMAIL">EMAIL</option>
      </select>
    </div>
    <div class="col-md-4">
      <label>Group</label>
      <select class="form-control" name="group_id" required>
        <option value="">Select...</option>
        <% (groups || []).forEach(function(g) { %>
          <option value="<%= g.id %>"><%= g.name %></option>
        <% }); %>
      </select>
    </div>
    <div class="col-md-1 d-flex align-items-end">
      <button type="button" class="btn btn-danger btn-remove-row">&times;</button>
    </div>
  `;
  return row;
}

document.getElementById('addRowBtn').addEventListener('click', function() {
  const newRow = createRow();
  newRow.querySelector('.btn-remove-row').style.display = '';
  newRow.querySelector('.btn-remove-row').addEventListener('click', function() {
    newRow.remove();
  });
  document.getElementById('notificationRows').appendChild(newRow);
});

document.querySelectorAll('.btn-remove-row').forEach(function(btn) {
  btn.addEventListener('click', function() {
    btn.closest('.notification-row').remove();
  });
});

document.getElementById('createNotificationsForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  const rows = document.querySelectorAll('.notification-row');
  const notifications = [];
  let valid = true;
  rows.forEach(function(row) {
    const object_type_id = row.querySelector('[name="object_type_id"]').value;
    const remind_in = row.querySelector('[name="remind_in"]').value;
    const remind_using = row.querySelector('[name="remind_using"]').value;
    const group_id = row.querySelector('[name="group_id"]').value;
    if (!object_type_id || !remind_in || !remind_using || !group_id) valid = false;
    notifications.push({ object_type_id, remind_in, remind_using, group_id });
  });
  if (!valid) {
    document.getElementById('notifMsg').innerHTML = '<div class="alert alert-warning">Please fill all fields.</div>';
    return;
  }
  const saveBtn = this.querySelector('button[type="submit"]');
  saveBtn.disabled = true;
  saveBtn.innerText = 'Saving...';
  document.getElementById('notifMsg').innerHTML = '';
  try {
    const res = await fetch('/dashboard/notifications/create', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ notifications })
    });
    const result = await res.json();
    if (result.success) {
      document.getElementById('notifMsg').innerHTML = '<div class="alert alert-success">Notifications created!</div>';
      setTimeout(() => window.location.href = '/dashboard/notifications', 1000);
    } else {
      document.getElementById('notifMsg').innerHTML = '<div class="alert alert-danger">' + (result.error || 'Failed to create notifications.') + '</div>';
    }
  } catch (err) {
    document.getElementById('notifMsg').innerHTML = '<div class="alert alert-danger">Failed to create notifications.</div>';
  }
  saveBtn.disabled = false;
  saveBtn.innerText = 'Save';
});
</script>
<%- include('layouts/footer') %> 