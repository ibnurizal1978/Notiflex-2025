<%- include('layouts/header') %>

      <main role="main" class="main-content">
        <div class="container-fluid">
          <div class="row justify-content-center">
            <div class="col-12">
              <div class="row align-items-center my-4">
                <div class="col">
                  <h2 class="h3 mb-0 page-title">Users</h2>
                </div>
                <div class="col-auto d-flex align-items-center">
                  <form class="form-inline mr-2 searchform text-muted" method="get" action="">
                    <input class="form-control" type="text" name="search" placeholder="Type something..." aria-label="Search" value="<%= typeof search !== 'undefined' ? search : '' %>">
                    <button class="btn btn-outline-secondary ml-2" type="submit">Search</button>
                  </form>
                  <a href="/dashboard/users/create" class="btn btn-primary ml-2"><span class="fe fe-filter fe-12 mr-2"></span>Create</a>
                </div>
              </div>
              <div class="row">
                <% const safeUsersPage = (typeof usersPage !== 'undefined' && usersPage) ? usersPage : []; %>
                <% if (safeUsersPage.length === 0) { %>
                  <div class="col-12"><p>No users found.</p></div>
                <% } %>
                <% safeUsersPage.forEach(function(user) { %>
                  <div class="col-md-3">
                    <div class="card shadow mb-4">
                      <div class="card-body text-center">
                        <div class="avatar avatar-lg mt-4">
                          <img src="/assets/avatars/face-1.jpg" alt="..." class="avatar-img rounded-circle">
                        </div>
                        <div class="card-text my-2">
                          <strong class="card-title my-0"><%= user.name || user.email %></strong>
                          <p class="small text-muted mb-0"><%= user.email %></p>
                          <p class="small"><span class="badge badge-light text-muted">Last login: <%= formatDateTime(user.updated_at) %></span></p>
                        </div>
                      </div>
                      <div class="card-footer">
                        <div class="row align-items-center justify-content-between">
                          <div class="col-auto">
                            <small>
                              <span class="dot dot-lg bg-<%= user.is_active ? 'success' : 'secondary' %> mr-1"></span> <%= user.is_active ? 'Active' : 'Login disabled' %> </small>
                          </div>
                          <div class="col-auto">
                            <div class="file-action">
                              <button type="button" class="btn btn-link dropdown-toggle more-vertical p-0 text-muted mx-auto" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <span class="text-muted sr-only">Action</span>
                              </button>
                              <div class="dropdown-menu m-2">
                                <a class="dropdown-item" href="/dashboard/users/edit/<%= encryptId(user.id) %>"><i class="fe fe-edit fe-12 mr-4"></i>Edit</a>
                                <% if (user.id !== userLoginId) { %>
                                  <a class="dropdown-item btn-delete-user" href="#" data-id="<%= encryptId(user.id) %>"><i class="fe fe-delete fe-12 mr-4"></i>Delete</a>
                                <% } %>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div> <!-- /.card-footer -->
                    </div>
                  </div>
                <% }) %>
              </div>
              <% const safeTotalPages = (typeof totalPages !== 'undefined' && totalPages) ? totalPages : 1; %>
              <% if (safeTotalPages > 1) { %>
              <nav aria-label="Table Paging" class="my-3">
                <ul class="pagination justify-content-end mb-0">
                  <% for (let i = 1; i <= totalPages; i++) { %>
                    <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                      <a class="page-link" href="?page=<%= i %>"><%= i %></a>
                    </li>
                  <% } %>
                </ul>
              </nav>
              <% } %>
            </div> <!-- .col-12 -->
          </div> <!-- .row -->
        </div> <!-- .container-fluid -->
      </main> <!-- main -->
    </div> <!-- .wrapper -->
  
<%- include('layouts/footer') %>

<script>
  document.querySelectorAll('.btn-delete-user').forEach(function(btn) {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      if (confirm('Are you sure you want to delete this user?')) {
        const encId = btn.getAttribute('data-id');
        fetch(`/dashboard/users/delete/${encId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        })
        .then(res => res.json())
        .then(result => {
          if (result.success) {
            window.location.reload();
          } else {
            alert(result.error || 'Failed to delete user.');
          }
        })
        .catch(() => alert('Failed to delete user.'));
      }
    });
  });
</script> 